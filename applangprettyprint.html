<!DOCTYPE html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>app language: prettyprint </title>
	<style>
		.mono {font-family: monospace}
		.sans {font-family: sans-serif}
		.serif {font-family: serif}
		code {background: rgba(142, 142, 145, 0.25)}
		.good {color: green;}
		.bad {color: red;}
		.spaces {white-space: pre-wrap;}
		td.top {vertical-align: top;}
		.inset {
			padding-left: 15px;
		}
		.one {color: blue;}
		.two {color: purple;}

		/* NFI if I got this right: seems to work in windows */
		.xmlbox {
			width: 20px;
		}
		.xmltop {
			background-color: #ccc;
			border-bottom: 3px solid black;
			margin-bottom: 1em;
			padding: 0.5em;
		}
		.xmlcontent {
			padding: 1em;
		}
	</style>
</head>

<body>
<p>
	<button type="button" onclick="measure()">measure</button>
	<p>Test generating deterministic results at any DPR <b>[NOTE:</b> designed for Base Browser 15+: tested only Windows so far</p>
	<details><summary>notes</summary>
	<ul>
		<li>There are three test columns (all these and the xmls use 20px width to ensure maximum lines)
			<ul>
				<li><u>visual</u>
					<div class="inset">for a direct comparison to the XML visual next to it
					<br>- this is just a visual where the words overflow (it's still 20px) but because of that sometimes <br>single-letter words can cause a mismatch in expected line numbers</li>
					</div>
				<li><u>latin</u> (to simplfy it)
					<div class="inset">uses the same (western/latin?) multi-char (to ensure line numbers)<br>word across all languages (<b>latn</b>)
						<br>- but some scripts require glyphs to force the correct font e.g. type <code>measure(true, ['my'])</code> into the console
					</div>
				<li><u>script</u> (to perfect it)
					<div class="inset">repeats the same latin/western multi-char word by default (<b>latn</b>) across all languages
						<br>except where it is needed and instead uses that script's unicode
						<div class="inset">- e.g. type <code>measure(true, ['zh-TW'])</code>, where <code>zh-TW</code> uses <b>包</b>
							<br>- e.g. <code>ja</code> uses <b>示</b>
						</div>
						<b>script</b> is the method that works
						<br>- Note that FF144+ switches to monospace for all raw XML
						<br>- Overcautious use in case the unicode causes new line heights
					</div>
				</li>
			</ul>
		</li>
		<li>each test
			<ul>
				<li>sets the <code>lang</code> attribute</li>
				<li>sets a <code>font-family</code> attribute (e.g. serif, sans-serif)</li>
			</ul>
		</li>
		<li>links
			<ul>
				<li><a target="_blank "href="https://searchfox.org/firefox-main/source/dom/xml/resources/XMLPrettyPrint.xsl">
					https://searchfox.org/firefox-main/source/dom/xml/resources/XMLPrettyPrint.xsl</a></li>
				<li><a target="_blank "href="chrome://global/content/xml/XMLPrettyPrint.css">
					chrome://global/content/xml/XMLPrettyPrint.css</a></li>
			</ul>
		</li>
	</ul>
	</details>
	<br>

	<div class="mono spaces">language: <span id='info'></span></div>
	<div class="mono spaces">     xml: <span id='xmlresult'></span></div>
	<div class="mono spaces">  visual: <span id='translationresult'></span></div>
	<div class="mono spaces">   latin: <span id='latinresult'></span></div>
	<div class="mono spaces">  script: <span id='linesresult'></span></div>
</p>


<table>
	<thead><tr>
		<th colspan="3" class="one">XML</th>
		<th colspan="3" class="two">TESTS</th>
	</tr></thead>
	<tr>
		<td class="one">large visual</td>
		<td class="one">test</td>
		<td class="one">long visual</td>
		<td class="two">visual</td>
		<td class="two">latin</td>
		<td class="two">script</td>

	</tr>
	<tr><td colspan="6" style="border-bottom; 2px;">&nbsp;</td></tr>

	<tr>
		<!--XML-->
		<td class="top"><iframe id='visual' width='300px' height='400px' src='applangprettyprint.xml'></iframe></td>
		<td class="top">
			<iframe id='xml' width='20px' height='30px' src='applangprettyprint.xml'></iframe>&nbsp; &nbsp; &nbsp; &nbsp;
		</td>
		<td class="top">
			<iframe width='20px' height='1500px' src='applangprettyprint.xml'></iframe>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
		</td>
		<!--TESTS-->
		<td class="top">
			<div class='xmlbox'>
				<div class='xmltop'><div class='xmlcontent' id="translation"></div></div>
				<div id='translationbottom'>&lt;a&gt;a&lt;/a&gt;</div>
			</div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
		</td>
		<td class="top">
			<div class='xmlbox'>
				<div class='xmltop'><div class='xmlcontent' id="latin"></div></div>
				<div id='latinbottom'>&lt;a&gt;a&lt;/a&gt;</div>
			</div>&nbsp;  &nbsp;  &nbsp;  &nbsp; &nbsp;  &nbsp;  &nbsp;  &nbsp; &nbsp;  &nbsp;  &nbsp;
		</td>
		<td class="top">
			<div class='xmlbox'>
				<div class='xmltop'><div class='xmlcontent' id="lines"></div></div>
				<div id='linesbottom'>&lt;a&gt;a&lt;/a&gt;</div>
			</div>&nbsp;  &nbsp;  &nbsp;  &nbsp; &nbsp;  &nbsp;  &nbsp;  &nbsp; &nbsp;  &nbsp;  &nbsp;
		</td>
	</tr>
</table>

<script>
'use strict';
// css
let s0 = "<span class='",
	sb = s0+"bad'>",
	sg = s0+"good'>",
	sc = "</span>",
	green_tick = "<span style='font-size: 10px;'><b>" + sg.trim() +" \u2713"+ sc + "</b></span>",
	red_cross = "<span style='font-size: 10px;'><b>" + sb.trim() +" \u2715"+ sc + "</b></span>"

let isLocale, isLanguage, data
let xml = document.getElementById('xml')

let translation = document.getElementById('translation'),
	lines = document.getElementById('lines'),
	latin = document.getElementById('latin')
let translationbottom = document.getElementById('translationbottom'),
	linesbottom = document.getElementById('linesbottom'),
	latinbottom = document.getElementById('latinbottom')

let aLoop = [], oData = {}, aNum, aSteps = []

// gecko version
let is144 = false
try {
	let list = [
		[DataTransfer, 'DataTransfer', 'mozSourceNode'],
		[Document, 'Document', 'mozFullScreen'],
		[HTMLCanvasElement, 'HTMLCanvasElement', 'mozPrintCallback'],
		[HTMLElement, 'HTMLElement', 'onmozfullscreenerror'],
		[HTMLVideoElement, 'HTMLVideoElement', 'mozDecodedFrames'],
		[IDBIndex, 'IDBIndex', 'mozGetAllKeys'],
		[IDBObjectStore, 'IDBObjectStore', 'mozGetAll'],
		[Screen, 'Screen', 'mozOrientation'], // 1325110: mozOrientation slated for deprecation
		[SVGElement, 'SVGElement', 'onmozfullscreenchange'] 
	]
	let obj, prop, aNo = []
	list.forEach(function(array) {
		obj = array[0]
		prop = array[2]
		if ('function' === typeof obj
			&& ('object' === typeof Object.getOwnPropertyDescriptor(obj.prototype, prop))) {
		} else {
			aNo.push(array[1])
		}
	})
	let found = (list.length - aNo.length)
	if (found > 5) {
		if (undefined == window.CSS2Properties) {
			is144 = true // at least FF144
			let aTargets144 = [translationbottom, linesbottom, latinbottom]
			aTargets144.forEach(function(target){
				target.classList.add('mono')
			})
		} 
	}
} catch(e) {
	console.log(e)
}

/*
https://searchfox.org/firefox-main/source/dom/locales/en-US/dom = XMLPrettyPrint
https://searchfox.org/firefox-main/source/dom/xml/resources/XMLPrettyPrint.xsl
chrome://global/content/xml/XMLPrettyPrint.css

*/
/*
- looks like we can use a single (latn) word and create x lines
	- except some scripts we need to use chars from that script
	- ^ my (burmese), zh-*, ka-GE
  - we just need to add that padding/margin around the translation
*/

let word = 'latn'

let oTest = {
	// note rtl results may vary in order due to mixed directional copypasta
	// we can use 'XML' + word x (number of lines - 1) instead of the translation

	// test widths are at width 20 to maximize number of lines
	// both short and tall match which gives us stability

	// the key is can we simulate an accurate measurement e.g. ±1
	// and persist that accuracy at any DRP/zoom etc

	// note: pretty print changed to monospace in FF144+
	// 1984997: Use monospace font for raw XML display

/*
RFP spoof switches in the spoofed english translation, but font styles (default sizes? default-fonts?)
cause AFAICT differences with ar, fa-IR, ja, ka-GE, ko-KR, th - all use sans-serif

RFP or BB could backport 1984997: Use monospace font for raw XML display

also seems as if those langs also don't use mono when spoofing english - tested in FF149 and TB147
- the "spoof" xml is missing the "Use monospace font for raw XML display" (I thought it just substituted it)?

*/


	// key: [ [heightTB15, heightTB 144+], lines, style, word, str]
	// height is windows 11 zoom 100% DPR 1 (for dev testing) to see if we can match it
 

	   'ar': [[376, 364], 13, 'ss', 'ليبدو', "يبدو أنّه ليس لملفّ XML معلومات طُرِز ترتبط به. شجرة المستند معروضة بأسفل"],
	   'be': [[391, 325], 16, 's', word, "Гэты файл XML не мае ніякіх звестак аб стылі, спалучаных з ім. Дрэва дакумента паказана ніжэй."],
	   'bg': [[373, 310], 15, 's', word, "Този XML файл изглежда няма прикачена стилова информация. Дървото на документа е показано по-долу."],
	   'ca': [[463, 385], 20, 's', word, "Aquest fitxer XML no sembla que tingui cap informació d'estil associada. Es visualitza a sota l'esquema en arbre del document."],
	   'cs': [[391, 325], 16, 's', word, "Tento XML soubor nemá připojeny žádné informace o vzhledu prvků. Strom XML dokumentu je zobrazen níže."],
	   'da': [[283, 235], 10, 's', word, "Denne XML-fil har ingen stilinformation tilknyttet. Dokumenttræet vises herunder."],
	   'de': [[427, 355], 18, 's', word, "Mit dieser XML-Datei sind anscheinend keine Style-Informationen verknüpft. Nachfolgend wird die Baum-Ansicht des Dokuments angezeigt."],
	'el-GR': [[391, 325], 16, 's', word, "Αυτό το αρχείο XML δεν φαίνεται να έχει συσχετισμένες πληροφορίες στυλ. Το δένδρο εγγράφου εμφανίζεται παρακάτω."],
	'en-US': [[463, 385], 20, 's', word, "This XML file does not appear to have any style information associated with it. The document tree is shown below."],
	'es-ES': [[427, 355], 18, 's', word, "Este fichero XML no parece tener ninguna información de estilo asociada. Se muestra debajo el árbol del documento."],
	'fa-IR': [[565, 562], 22, 'ss', 'تتت', "اطلاعات XML به نظر می‌رسد که این پروندهٔ نمایش ندارد. درخت این در مورد سبک نوشتار در زیر نمایش داده شده است."],
	'fi-FI': [[391, 325], 16, 's', word, "Tämän XML-dokumentin mukana ei näytä olevan mitään tyyli- tai muotoilutietoa. Dokumentin hierarkia-puu on alla."],
	   'fr': [[427, 355], 18, 's', word, "Aucune information de style ne semble associée à ce fichier XML. L’arbre du document est affiché ci-dessous."],
	'ga-IE': [[445, 370], 19, 's', word, "Is cosúil nach mbaineann aon fhaisnéis stíle leis an gcomhad XML seo. Tá an crann cáipéise le feiceáil thíos."],
	   'he': [[355, 308], 14, 's', 'קובץ', "מידע על סגנון נראה שלקובץ XML זה אין המשויך אליו. עץ המסמך מוצג להלן"],
	'hu-HU': [[319, 265], 12, 's', word, "Ehhez az XML-fájlhoz nem tartozik stíluslap-információ. A dokumentumfa az alábbi."],
	   'id': [[373, 310], 15, 's', word, "Tampaknya berkas XML berikut tidak menginformasikan gaya yang diinginkan. Pohon dokumen ditampilkan di bawah ini."],
	   'is': [[445, 370], 19, 's', word, "Þessi XML skrá virðist ekki vera með neinar upplýsingar um stílsnið. Tré fyrir skjalið er sýnt hér fyrir neðan."],
	'it-IT': [[463, 385], 20, 's', word, "Sembra che il file XML specificato non abbia un foglio di stile associato. L’albero del documento è visualizzato di seguito."],
     'ja': [[967, 961], 45, 's', '示',   "この XML ファイルにはスタイル情報が関連付けられていないようです。以下にドキュメントツリーを表示します。"],
  'ja-JP': [[967, 961], 45, 's', '示',   "この XML ファイルにはスタイル情報が関連付けられていないようです。以下にドキュメントツリーを表示します。"],
				// ^ ja-JP for macOS
	'ka-GE': [[455, 373], 16, 's', 'მჩნ', "ეს XML-ფაილი, როგორც ჩანს, არ შეიცავს მასთან დაკავშირებული სტილის რამე მონაცემებს. დოკუმენტის სქემა ქვემოთაა მოყვანილი."],
	'ko-KR': [[901, 892], 38, 'ss', '이', "이 XML 파일은 관련된 스타일 정보를 가지고 있지 않은 것 같습니다. 문서 트리는 아래와 같습니다."],
	   'lt': [[319, 265], 12, 's', word, "XML failas neturi susietos su juo stilių informacijos. Dokumento medis parodytas žemiau."],
	'mk-MK': [[481, 400], 21, 's', word, "Се чини дека оваа XML датотека нема информации за стилот кои се однесуваат на неа. Стеблото на документот е прикажано подолу."],
	   'ms': [[373, 310], 15, 's', word, "Fail XML tidak ada sebarang maklumat gaya yang dikaitkan dengannya. Pepohon dokumen ditunjukkan di bawah."],
	   'my': [[1321,730], 31, 's', 'ဆက်', "XML ဖိုင်မှာ ၄င်းနဲ့ သက်ဆိုင်တဲ့ အချက်အလက် ပုံစံတခုခု ရှိပုံမပေါ်ဘူး။ အချက်အလက် ဆင်းသက်မှုကို အောက်မှာ ဖေါ်ပြထားတယ်။"],
	'nb-NO': [[301, 250], 11, 's', word, "Denne XML-filen har ingen vedlagt stilinformasjon. Rent dokumenttre vises under."],
	   'nl': [[355, 295], 14, 's', word, "Dit XML-bestand lijkt geen geassocieerde stijlinformatie te hebben. De documentstructuur is hieronder weergegeven."],
	   'pl': [[373, 310], 15, 's', word, "Podany plik XML nie zawiera żadnych informacji o stylach z nim związanych. Poniżej wyświetlone jest drzewo dokumentu."],
	'pt-BR': [[463, 385], 20, 's', word, "Este arquivo XML não parece ter qualquer informação de estilo associado a ele. A estrutura do documento é mostrada abaixo."],
	'pt-PT': [[481, 400], 21, 's', word, "Este ficheiro XML não parece ter qualquer tipo de informação de estilo associada. A árvore do documento é mostrada em baixo."],
	'ro-RO': [[445, 370], 19, 's', word, "Acest fișier XML nu pare să aibă vreo informație de stil asociată lui. Mai jos este afișat arborele documentului."],
	'ru-RU': [[355, 295], 14, 's', word, "С этим XML-файлом не связана ни одна таблица стилей. Ниже показано дерево элементов."],
	   'sq': [[445, 370], 19, 's', word, "Kjo kartelë XML nuk duket se ka ndonjë të dhënë stili përshoqëruar asaj. Pema e dokumentit tregohet më poshtë."],
	'sv-SE': [[319, 265], 12, 's', word, "Denna XML-fil verkar inte ha någon associerad stilinformation. Dokumentträdet visas nedan."],
	   'th': [[483, 405], 20, 's', 'ไฟล์', "ไฟล์ XML นี้ ดูเหมือนจะไม่มีข้อมูลสไตล์ใด ๆ ที่เกี่ยวข้องกัน ต้นไม้เอกสารถูกแสดงด้านล่าง "],
				// th: copypasta edited (addd a space) to cause correct number of lines: not that we are going to use translations in TZP
	'tr-TR': [[355, 295], 14, 's', word, "Bu XML belgesi ile herhangi bir stil bilgisi bağlantılı değil. Belge ağacı aşağıda gösterilmiştir."],
	'uk-UA': [[373, 310], 15, 's', word, "Схоже, цей XML-файл не має жодної пов'язаної інформації зі стилів. Нижче показано дерево елементів."],
	'vi-VN': [[553, 460], 25, 's', word, "Tập tin XML có vẻ như không có thông tin kiểu nào đi kèm với nó. Cấu trúc tài liệu được hiển thị bên dưới."],
	'zh-CN': [[607, 547], 24, 'ss', '文', "该 XML 文件并未包含任何关联的样式信息。文档树显示如下。"],
	'zh-TW': [[625, 547], 25, 'ss', '包', "此 XML 未包含顯示用的樣式資訊。將以文件樹的方式顯示如下。"],
} 

function set_info() {
	try {isLocale = Intl.DateTimeFormat().resolvedOptions().locale} catch(e) {isLocale = 'error'; console.log(e)}
	try {isLanguage = navigator.language} catch(e) {isLanguage = 'error'; console.log(e)}
	document.getElementById('info').innerHTML = 'language: '+ isLanguage +' | locale: '	+ isLocale
	set_attributes(isLanguage)
	// populate aLoop
	let sNum = new Set()
	for (const k of Object.keys(oTest).sort()) {
		aLoop.push(k)
		let index = is144 ? 1 : 0
		sNum.add(oTest[k][0][index]) // get unique sizes
	}
	aNum = Array.from(sNum).sort(function(a, b){return a - b}) // sort numerically
	for (let i=0; i < aNum.length -1; i++) {
		aSteps.push([aNum[i+1] +' to '+ aNum[i], aNum[i+1] - aNum[i]])
	}
	console.log('TB'+ (is144 ? ' (FF144+)' : '') +', Windows 11, DRP 1, 100% zoom data')
	console.log('Range\n', aNum)
	console.log('Steps\n', aSteps)
}

function set_attributes(lang) {
	let style
	if (undefined == lang) {lang = isLanguage}
	try {
		data = oTest[lang]
		if (undefined !== data) {
			// lang attribute and style
			style = 's' == data[2] ? 'serif' : ('ss'== data[2] ? 'sans' : 'mono') // class to apply
			// note: pretty print changed to monospace in FF144+
			// 1984997: Use monospace font for raw XML display
			if (is144) {style = 'mono'}
			let aTargets = [translation, lines, latin]
			aTargets.forEach(function(target){
				target.setAttribute('lang', lang)
				let newtarget = target.parentNode
				newtarget.classList.remove('mono')
				newtarget.classList.remove('serif')
				newtarget.classList.remove('sans')
				newtarget.classList.add(style)
			})
			// populate
			let lineWords = Array(data[1]-1).fill(data[3]); lineWords.push('XML')
			let latnWords = Array(data[1]-1).fill('latn'); latnWords.push('XML')
			translation.innerHTML = data[4]
			lines.innerHTML = lineWords.join(' ')
			latin.innerHTML = latnWords.join(' ')
		}
	} catch(e) {
		console.log(e)
	}
	return style
}
set_info()

// https://thorin-oakenpants.github.io/testing/applangprettyprint.html
// we need to wait for the xml file to load
	// just stick it behind a button for now
function measure(isLoop = false, aList) {
	let xmlH, xmlError = false
	if (undefined == aList || aList.length == 0) {
		aList = isLoop ? aLoop : [isLanguage]
	}
	if (isLoop) {
		oData = {} // reset
		document.getElementById('xmlresult').innerHTML = ''
	} else {
		// not looping
		document.getElementById('info').innerHTML = 'language: '+ isLanguage +' | locale: '	+ isLocale
		try {
			xmlH = xml.contentDocument.firstChild.getBoundingClientRect().height
		} catch(e) {
			xmlError = true
			xmlH = e+''
		}
		if ('number' == typeof xmlH && xmlH < 50) {
			// do nothing, the user clicked before the xml loaded
			// ands instead measured the empty iframe
			xmlError = true
			xmlH = 'XML not loaded yet... try again'
		}
		document.getElementById('xmlresult').innerHTML = xmlH
	}


	let oTarget = {
		'translation': translation.parentNode.parentNode,
		'lines': lines.parentNode.parentNode,
		'latin': latin.parentNode.parentNode,
	}
	let heightSet = new Set()
	aList.forEach(function(lang){
		let style = set_attributes(lang)
		heightSet.clear()
		if (undefined !== data) {
			for (const t of Object.keys(oTarget)) {
				let height = oTarget[t].getBoundingClientRect().height
				heightSet.add(height)
				let info = '', match = ''
				if ('lines' == t) {
					document.getElementById('info').innerHTML = 'language: '+ lang + (isLoop ? ' [simulated]' : '')
					let index = is144 ? 1 : 0
					let diff = data[0][index] - height // debugging diff
					oData[lang] = [diff, style]
					if (!xmlError) {
						let realdiff = height - xmlH
						// allow for some system scaling: not sure if I've exactly replicated the code/css
						// sometimes we can be out by a TINY bit (0.00006... is the highest so far, excluding aIncrease in TB16 below)
						// but given overall minimal diffs (steps between entropy buckets in numerical order) are 2 or 3 pixels
						// in TB at 100% zoom, not sure about 144+ with monospace) we can allow some wriggle room - let's try ± 0.25
						let margin = 0.25
						if (is144) {
							// CJK has issues: about 6 pixels diff, but they are large and have
							// big steps to the nearest other langauge sizes
							let aIncrease = [
								// at least on windows DRP 1 (at 100% zoom)
									// all are miles away from en-US which is the only one spoofed
									// amd due to fixing mismatched locales+language + forcing restart on lang change
									// we should never get anything but the actual lang vs en-US
								'ja','ja-JP', // at 961 nearest is 892 = ko = 69 away 
								'ko',         // at 892 nearest is 961 = ja = 69 away
								'zh-CN',      // at 547 nearest is 562 = fa-IR = 15 away
								'zh-TW'       // at 547 nearest is 562 = fa-IR = 15 away
							]
							if (aIncrease.includes(lang)) {margin = 12}
						}
						let isMatch = (Math.abs(height - xmlH) < margin)
						match = ''
						if (!isLoop) {
							match = (isMatch ? sg +' [' + green_tick : sb +' ['+ red_cross)+' match xml'
							if (realdiff !== 0) {match += ' | diff: ' + realdiff}
							match += ']'+ sc
						}
					}
					info = ' [expected: ' + data[0] + ' | diff: ' + diff +' | font-family: ' + style +']'
				}
				let sizes =''
				if ('latin' == t) {sizes = (1 == heightSet.size ? sg +' ['+ green_tick : sb +' ['+ red_cross) + ' test sizes match each other]'+ sc}
				document.getElementById(t + 'result').innerHTML = height + match + sizes //+ info
			}
		}
	})
	if (isLoop) {console.log('TB'+ (is144 ? ' (FF144+)' : '') +', Windows 11, DRP 1, 100% zoom check\n', oData)}
}


</script>
</body>
</html>


