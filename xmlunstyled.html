<!DOCTYPE html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>xml unstyled</title>
</head>

<body>
<p id='info'></p>
<p>xslt: <span id='xslterror'></span> &nbsp; <bdo dir='ltr'><span id='xslthash'></span></bdo></p>
<p><button type="button" onclick="measure()">measure</button> &nbsp; <span id='results'><span></p>

<!-- tzp uses 40px x 30px: height can change measurements
	so for stability we squeeze all translations into a size that is too small
-->
<iframe id='test' width='40px' height='30px' src='xmlunstyled.xml'></iframe><br>
<iframe id='view' width='40px' height='600px' src='xmlunstyled.xml'></iframe>
<iframe id='visual' width='200px' height='600px' src='xmlunstyled.xml'></iframe>
<iframe id='xslt' width='200px' height='600px' src='xslterror1.xml'></iframe>
</div>


<script>
'use strict';
// https://searchfox.org/firefox-main/source/dom/locales/en-US/dom = XMLPrettyPrint

function mini(str) {
	// https://stackoverflow.com/a/22429679
	const json = `${JSON.stringify(str)}`
	let len = json.length, hash = 0x811c9dc5
	for (let i=0; i < len; i++) {
		hash = Math.imul(31, hash) + json.charCodeAt(i) | 0
	}
	return ('0000000' + (hash >>> 0).toString(16)).slice(-8)
}

function set_info() {
	let isLocale, isLanguage
	try {
		isLocale = Intl.DateTimeFormat().resolvedOptions().locale
	} catch(e) {
		isLocale = 'error'; console.log(e)
	}
	try {
		isLanguage = navigator.language
	} catch(e) {
		isLanguage = 'error'; console.log(e)
	}
	document.getElementById('info').innerHTML = 'language: '+ isLanguage +' | locale: '+ isLocale
}
set_info()

let target = document.getElementById('test'),
	view = document.getElementById('view'),
	visual = document.getElementById('visual'),
	xslt = document.getElementById('xslt')

// we need to wait for the xml file to load
	// just stick it behind a button for now
function measure() {
	let testheight, viewheight, visualheight, xsltresult, xslthash =''
	try {
		testheight = target.contentDocument.firstChild.getBoundingClientRect().height
	} catch(e) {
		console.log('testheight',e)
		testheight = 'error'
	}

	try {
		viewheight = view.contentDocument.firstChild.getBoundingClientRect().height
	} catch(e) {
		console.log('viewheight',e)
		viewheight = 'error'
	}

	try {
		visualheight = visual.contentDocument.firstChild.getBoundingClientRect().height
	} catch(e) {
		console.log('visualheight',e)
		visualheight = 'error'
	}
	document.getElementById('results').innerHTML = 'short: '+ testheight
		+' | tall: '+ viewheight +' | visual: '+ visualheight

	// get xslt style error
	try {
		xsltresult = xslt.contentDocument.children[0].textContent
		xslthash = mini(xsltresult)
	} catch(e) {
		xsltresult = e
	}
	document.getElementById('xslterror').innerHTML = xsltresult
	document.getElementById('xslthash').innerHTML = xslthash
}
</script>
</body>
</html>

